# Issue #6 検討経緯まとめ：インフラコスト最適化・スケーラビリティ対策

GitHub Issue #6 [インフラコスト最適化・スケーラビリティ対策：D案（アフィリエイトリダイレクト機能強化）実装計画](https://github.com/hidezoh/dti-affi/issues/6) における検討プロセスと最終決定事項をまとめます。

## 1. 検討の背景
当初、Vercel + SQLite（ローカルファイル）による「D案」が提案されましたが、議論の中で**パフォーマンス**と**デプロイ環境の制約**に関する重大な課題が判明し、方針が転換されました。

## 2. 検討プロセスと変遷

### 当初の提案 (D案)
- **構成**: Vercel + SQLite (Read-Only)
- **課題**: 12万件のデータに対する `LIKE` 検索が遅すぎる（2-8秒）。ユーザー体験として許容できない。

### 第2案: Convex
- **提案**: 高速な検索とサーバーレス環境を提供するConvexへの移行。
- **却下理由**: 日本語の全文検索（形態素解析）の精度が低く、アダルトコンテンツ特有の検索ニーズ（表記ゆれ等）を満たせないため。

### 第3案: SQLite FTS5
- **提案**: SQLiteの全文検索機能 (FTS5) を利用し、コストゼロで高速化する。
- **却下理由**: **Vercel Serverless Functions では SQLite ファイル（ローカルDB）が利用できない** というプラットフォームの制約が判明したため。

## 3. 最終決定事項 (Cloudflare D1)

Vercelの制約とコスト要件（Phase 1: ¥0）を満たす最適解として、**Cloudflare D1** への移行が決定されました。

### 採用構成: Cloudflare D1 + KV
- **データベース**: Cloudflare D1 (SQLite互換の分散DB)
- **キャッシュ**: Cloudflare KV (検索結果キャッシュ)
- **ホスティング**: Cloudflare Workers / Pages (または Vercel から D1 へ接続)

### 選定理由
1.  **Vercel制約の回避**: サーバーレス環境で動作するSQLite互換DBである。
2.  **コスト適合**: Phase 1 の予算（¥0）内で運用可能。
3.  **パフォーマンス**: 検索応答 100-200ms を実現可能（LIKE検索比 95%改善）。
4.  **スケーラビリティ**: グローバル分散と自動スケールに対応。

## 4. 今後のアクション (Phase 1)
1.  **Cloudflare D1 へのデータ移行**: 既存の SQLite データを D1 へインポート。
2.  **APIの実装**: Next.js (または Workers) から D1 を参照する検索 API を実装。
3.  **検索最適化**: D1 上でのインデックス設計とクエリ最適化。

## 5. 将来の展望 (Phase 2以降)
収益化が進んだ段階（月間1万円〜）で、より高度な日本語検索が必要になった場合は、**Cloudflare + Meilisearch** 構成への移行を再検討します。
